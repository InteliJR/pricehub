generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTENTICAÇÃO E USUÁRIOS
// ============================================

enum UserRole {
  ADMIN
  COMERCIAL
  LOGISTICA
  IMPOSTO
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdProducts Product[]
  revokedTokens   RevokedToken[]

  @@map("users")
}

model RevokedToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@index([userId])
  @@map("revoked_tokens")
}

// ============================================
// FRETE (TRANSPORTE)
// ============================================

enum Currency {
  BRL
  USD
  EUR
}

enum FreightOperationType {
  INTERNAL
  EXTERNAL
}

model Freight {
  id               String               @id @default(uuid())
  name             String
  description      String?              @db.Text
  unitPrice        Decimal              @db.Decimal(12, 2)
  currency         Currency             @default(BRL)
  originUf         String
  originCity       String
  destinationUf    String
  destinationCity  String
  cargoType        String
  operationType    FreightOperationType
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  freightTaxes FreightTax[]
  rawMaterials RawMaterial[]

  @@map("freights")
}

model FreightTax {
  id        String   @id @default(uuid())
  freightId String
  name      String
  rate      Decimal  @db.Decimal(5, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  freight Freight @relation(fields: [freightId], references: [id], onDelete: Cascade)

  @@index([freightId])
  @@map("freight_taxes")
}

// ============================================
// MATÉRIAS-PRIMAS
// ============================================

enum MeasurementUnit {
  KG
  G
  L
  ML
  M
  CM
  UN
  CX
  PC
}

model RawMaterial {
  id                 String          @id @default(uuid())
  code               String          @unique
  name               String
  description        String?         @db.Text
  measurementUnit    MeasurementUnit
  inputGroup         String?
  paymentTerm        Int
  acquisitionPrice   Decimal         @db.Decimal(12, 2)
  currency           Currency        @default(BRL)
  priceConvertedBrl  Decimal         @db.Decimal(12, 2)
  additionalCost     Decimal         @default(0) @db.Decimal(12, 2)
  freightId          String
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  freight              Freight                @relation(fields: [freightId], references: [id], onDelete: Restrict)
  productRawMaterials  ProductRawMaterial[]
  changeLogs           RawMaterialChangeLog[]
  rawMaterialTaxes     RawMaterialTax[]

  @@index([code])
  @@index([name])
  @@index([freightId])
  @@map("raw_materials")
}

model RawMaterialChangeLog {
  id            String   @id @default(uuid())
  rawMaterialId String
  field         String
  oldValue      String?
  newValue      String?
  changedBy     String
  changedAt     DateTime @default(now())

  rawMaterial RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)

  @@index([rawMaterialId])
  @@index([changedAt])
  @@map("raw_material_change_logs")
}

model RawMaterialTax {
  id            String   @id @default(uuid())
  rawMaterialId String
  name          String
  rate          Decimal  @db.Decimal(5, 2)
  recoverable   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  rawMaterial RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Cascade)

  @@index([rawMaterialId])
  @@map("raw_material_taxes")
}

// ============================================
// PRODUTOS E GRUPOS
// ============================================

model ProductGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@index([name])
  @@map("product_groups")
}

model Product {
  id                          String   @id @default(uuid())
  code                        String   @unique
  name                        String
  description                 String?  @db.Text
  creatorId                   String
  priceWithoutTaxesAndFreight Decimal? @db.Decimal(12, 2)
  priceWithTaxesAndFreight    Decimal? @db.Decimal(12, 2)
  fixedCostId                 String?
  productGroupId              String?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  creator             User                 @relation(fields: [creatorId], references: [id])
  fixedCost           FixedCost?           @relation(fields: [fixedCostId], references: [id], onDelete: SetNull)
  productGroup        ProductGroup?        @relation(fields: [productGroupId], references: [id], onDelete: SetNull)
  productRawMaterials ProductRawMaterial[]

  @@index([code])
  @@index([name])
  @@index([fixedCostId])
  @@index([productGroupId])
  @@map("products")
}

model ProductRawMaterial {
  productId     String
  rawMaterialId String
  quantity      Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  rawMaterial RawMaterial @relation(fields: [rawMaterialId], references: [id], onDelete: Restrict)

  @@id([productId, rawMaterialId])
  @@map("product_raw_materials")
}

// ============================================
// CUSTOS FIXOS
// ============================================

model FixedCost {
  id                      String   @id @default(uuid())
  description             String
  code                    String?  @unique
  personnelExpenses       Decimal  @db.Decimal(12, 2)
  generalExpenses         Decimal  @db.Decimal(12, 2)
  proLabore               Decimal  @db.Decimal(12, 2)
  depreciation            Decimal  @default(0) @db.Decimal(12, 2)
  totalCost               Decimal  @db.Decimal(12, 2)
  considerationPercentage Decimal  @default(100) @db.Decimal(5, 2)
  salesVolume             Decimal  @db.Decimal(12, 2)
  overheadPerUnit         Decimal  @db.Decimal(12, 2)
  calculationDate         DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  products Product[]

  @@index([calculationDate])
  @@map("fixed_costs")
}